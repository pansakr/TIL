### 무결성

* 데이터가 잘못된 상태로 저장되지 않도록 보장하는 것

* 무결성의 속성 (데이터 품질이 지향해야 할 목표)

  - 정합성 : 회원의 나이는 - 로 저장되면 안됨
 
  - 일관성 : 1번 회원의 이름이 어떤 테이블에서 '하늘' 일 때, 다른 테이블에서 '바다' 로 저장되면 안됨
 
  - 정확성 : 주문이 있는데, 실제로 존재하지 않는 상품 ID를 참조하면 안됨
 
* 무결성의 종류 (목표를 달성하기 위한 제약 조건)

  - 개체 무결성 (PRIMARY KEY, UNIQUE, NOT NULL)
 
    - 기본키는 NULL 이 될 수 없고, 중복될 수 없음
   
    - 회원 테이블에서 회원 번호가 NULL 이거나, 1번 회원이 두 번 나오면 무결성 깨짐
   
  - 참조 무결성 (FOREIGN KEY)
 
    - 외래키는 반드시 실제로 존재하는 기본키 값만 참조해야 함
   
    - 주문 테이블에서 상품 ID = 10 을 가리키고 있는데, 상품 테이블에 10번 상품이 없으면 무결성 깨짐
   
  - 도메인 무결성 (CHECK, DEFAULT, 컬럼 데이터 타입)
 
    - 컬럼 값은 정해진 도메인(범위/타입) 안에 있어야 함
   
    - 나이는 음수가 될 수 없고, 이메일은 특정 형식이어야 함
   
    - 제약조건으로 보장할 수 있음
   
  - 사용자 정의 무결성 (애플리케이션 로직)
 
    - 특정 비즈니스 규칙에 따른 무결성
   
    - 한 사람은 특정 상품을 한 달에 10개 까지만 구매할 수 있다    

### 정규화

* 데이터의 중복을 최소화하고 무결성을 높이기 위해 테이블을 쪼개고 관계를 정리하는 과정

  - 데이터의 삽입/수정/삭제 시 데이터 불일치 방지
 
* 정규화는 5단계까지 있고, 아래 단계로 갈수록 세분화되어 테이블 개수가 많아진다

  - 지나치게 정규화하면 테이블이 너무 잘게 쪼개져서 조회할 때 조인이 과도하게 발생하므로 성능이 저하된다
 
  - 보통 3정규형 또는 BCNF 정도까지만 적용한다

### 이상 현상

* 테이블을 잘못 설계하여 데이터를 삽입/삭제/수정 할 때 발생하는 논리적 오류

* 갱신 이상

  - 중복된 데이터 중 일부만 수정되어 데이터의 불일치가 발생하는 현상

  ```
  과목 테이블
  +---------+---------+----------+
  | 과목ID  | 과목명  | 교수명   | 교수학과  |
  +---------+---------+----------+----------+
  | 1       | 수학    | 김교수   | 수학과   |
  | 2       | 통계    | 김교수   | 수학과   |
  | 3       | 물리    | 박교수   | 물리학과 |
  ```

  - '김교수' 는 수학과이고 수학, 통계 과목을 담당하고 있음
 
  - 이때 '김교수' 가 통계학과로 옮겼다면 '김교수' 가 들어간 모든 행을 수정해야 함
 
  - 만약 과목명이 '수학' 인 행은 수정했는데, '통계' 인 행은 수정하지 않았다면 같은 사람인데 어떤 행은 '수학과', 어떤 행은 '통계학과' 로 데이터 불일치 발생
   
* 삽입 이상

  - 자료를 삽입할 때 의도하지 않은 자료까지 삽입해야 테이블에 삽입이 가능한 현상
 
  ```
  과목 테이블
  +---------+---------+----------+----------+
  | 과목ID  | 과목명  | 교수명   | 교수학과 |
  +---------+---------+----------+----------+
  | 1       | 수학    | 김교수   | 수학과  |
  | 2       | 통계    | 이교수   | 통계학과|
  ```

  - '박교수(물리학과)' 를 추가하려 하지만, 아직 담당 과목이 없음
 
  - 그러나 테이블 구조상 과목명은 NOT NULL 이라 반드시 입력해야 함
 
  - 그 결과 과목명에 억지로 NULL 같은 가짜 데이터를 넣어야 데이터 추가가 가능하게 됨
 
* 삭제 이상

  - 어떤 정보를 삭제하면 의도하지 않은 다른 정보까지 삭제되어 버리는 현상
 
  ```
  과목 테이블
  +---------+---------+----------+----------+
  | 과목ID  | 과목명  | 교수명   | 교수학과 |
  +---------+---------+----------+----------+
  | 1       | 수학    | 김교수   | 수학과  |
  | 2       | 통계    | 이교수   | 수학과  |
  ```

  - 통계 과목이 폐강되서 과목 ID = 2 인 행을 삭제함
 
  - 그 결과 '이교수' 라는 교수 정보도 같이 사라짐
 
  - 과목 데이터 삭제와 별개로 교수 정보는 존재해야 하지만, 함께 삭제되는 문제 발생
 
* 이런 이상 현상들은 정규화를 통해 해결할 수 있음

  - 교수 테이블(교수ID, 이름, 학과), 과목 테이블(과목ID, 과목명, 교수ID FK) 로 분리하면 문제가 사라짐


#### 제1 정규형 (1NK)

* 테이블의 컬럼이 원자 값(하나의 값만 갖) 을 갖도록 하는 것

  - 한 컬럼에 여러 값이 들어가면 안된다

* 정규화 전

    ```
    +--------+------+---------------------+
    | 학생ID | 이름 | 연락처              |
    +--------+------+---------------------+
    | 1      | 하늘 | 010-1111, 010-2222 |
    | 2      | 바다 | 010-3333           |
    +--------+------+---------------------+
    ```

    - 학생 ID 1번 행의 연락처 컬럼에 두 개의 값이 들어가 있으므로 1 정규형 위반

* 정규화 후

    ```
    +--------+------+----------+
    | 학생ID | 이름 | 연락처   |
    +--------+------+----------+
    | 1      | 하늘 | 010-1111 |
    | 1      | 하늘 | 010-2222 |
    | S      | 바다 | 010-3333 |
    +--------+------+----------+
    ```

#### 제2 정규형 (2NK)

* 1 정규형을 만족하면서 완전 함수 종속을 만족하도록 테이블을 분해하는 것 (기본키의 부분 종속 제거)

  - 완전 함수 종속 : 기본키의 부분집합이 결정자가 되어선 안된다는 것을 의미

    - 기본키가 복합키일 때 복합키의 일부만 가지고 다른 컬럼을 결정지을 수 있으면 안됨

    - 복합키인 경우 컬럼이 PK의 일부에만 종속되면 분리해야 함

* 정규화 전

    ```
    학생 테이블 (기본키 : 학생ID, 과목ID)
    +--------+--------+----------+--------+------+
    | 학생ID | 과목ID | 학생이름  | 과목명 | 점수 |
    +--------+--------+----------+--------+------+
    | S1     | C1     | 철수     | 수학   | 90   |
    | S1     | C2     | 철수     | 영어   | 80   |
    +--------+--------+----------+--------+------+
    ```

    - 학생 이름은 학생 ID에만 종속, 과목명은 과목 ID에만 종속되므로 2 정규형 위반

* 정규화 후

    ```
    학생 테이블
    +--------+----------+
    | 학생ID | 학생이름 |
    +--------+----------+
    | S1     | 철수     |
    +--------+----------+
    ```
    ```
    과목 테이블
    +--------+--------+
    | 과목ID | 과목명 |
    +--------+--------+
    | C1     | 수학   |
    | C2     | 영어   |
    +--------+--------+
    ```
    ```
    성적 테이블
    +--------+--------+------+
    | 학생ID | 과목ID | 점수 |
    +--------+--------+------+
    | S1     | C1     | 90   |
    | S1     | C2     | 80   |
    +--------+--------+------+
    ```

    - 실제 업무에서는 자동 증가 정수를 기본키로 사용하므로 부분 함수 종속 문제가 거의 발생하지 않음
   
    - 조인 테이블의 경우 복합키를 사용할 수도 있음


#### 제3 정규형 (3NK)

* 2 정규형을 만족하면서 모든 비주요 속성들이 기본키에 직접 종속하도록 테이블을 분해하는 것(이행적 함수 종속 제거)

* 직접 종속

  - 기본키가 다른 속성을 직접 결정하는 경우
 
  - A(기본키) -> B

* 함수 종속

  - 어떤 속성의 각 값에 대해 다른 속성의 각 값이 연관되는 것

  - A -> B : A 값이 같으면 B 값도 항상 같다
 
    - A : 결정자
   
    - B : 종속자 
 
  - 기본키가 A 인 행의 모든 컬럼들은 A 에 함수 종속된다

* 이행적 함수 종속

  - 기본키가 비 주요 속성을 거쳐 또 다른 비 주요 속성을 결정하는 것 

  - A(기본키) → B , B → C 가 성립할 때 A → C 가 성립되는 것

  - 기본키인 속성 A 가 B 를 결정하고, B 가 또 다른 속성 C 를 결정한다면 A 는 C 를 간접적으로 결정하게 된다
 
  - 이때 A -> C 의 관계가 생기는데, 이를 이행적 종속이라 한다
 
  - A → B , B → C, A -> C 에서 A 가 기본키가 아닌 경우도 제거해야 한다
  
    - 이 경우 A 가 기본키가 아니기 때문에 이행적 함수 종속은 아님
    
    - 하지만 A -> B, B -> C, A -> C 모든 상황이 3 정규형을 위반하기 때문

  - 예시
 
    - 이행적 함수 종속이 아닌 경우 

      ```
      학생 테이블 (학번 : PK)
      +--------+--------+------+
      | 학번   | 이름    | 나이 |
      +--------+--------+------+
      | 1      | 하늘    | 20   |
      | 2      | 바다    | 21   |
      | 3      | 바다    | 22   |
      +--------+--------+------+
      ```
    
      - 학번 -> 이름 : 학번이 이름을 결정하므로 성립
     
      - 이름 -> 나이 : 같은 이름은 다른 나이를 가질 수 있음. 따라서 이름은 나이를 결정하지 않으므로 성립하지 않음
     
        - 나이가 이름에 종속적이지 않으므로 이름 -> 나이 는 성립 안됨   
     
      - 학번 -> 나이 : 학번이 나이를 결정하므로 성립
     
        - 나이 컬럼이 이름 컬럼을 거치지 않고 바로 학번에 종속되므로 이행적 종속 아님 

    - 이행적 함수 종속인 경우

      ```
      학생 테이블 (학번 : PK)
      +--------+------+--------+--------+
      | 학번   | 이름  | 반ID   | 반이름 |
      +--------+------+--------+--------+
      | 2023001| 홍길동 | 1A    | 1학년 A반 |
      | 2023002| 이영희 | 2B    | 2학년 B반 |
      | 2023003| 박철수 | 1A    | 1학년 A반 |
      +--------+------+--------+--------+
      ```

      - 학번 -> 반 ID : 학번은 반 ID를 결정하므로 성립
     
      - 반 ID -> 반 이름 : 반 ID 는 반 이름을 결정하므로 성립
     
      - 학번 -> 반 이름 : 학번은 반 이름을 결정하므로 성립
     
        - 반 이름 컬럼은 반 ID 컬럼을 거쳐 학번 컬럼에 종속된 것이기 때문에 이행적 종속에 해당됨
       
        - 정규화 대상에 해당

    - 정규화 후
   
      ```
      학생 테이블
      +--------+------+--------+
      | 학번   | 이름 | 반ID   |
      +--------+------+--------+
      | 2023001| 홍길동 | 1A    |
      | 2023002| 이영희 | 2B    |
      | 2023003| 박철수 | 1A    |
      ```
   
      - 이름과 반 ID는 학번(기본키) 에 직접적을 종속됨
      
      ```
      반 테이블
      +--------+-----------+
      | 반ID   | 반이름    |
      +--------+-----------+
      | 1A     | 1학년 A반 |
      | 2B     | 2학년 B반 |
      ```

      - 반 이름은 반 ID(기본키) 에 직접적으로 종속됨

#### 보이스-코드 정규형 (BCNF : Boyce-Codd Normal Form)

* 3 정규형을 만족하고, 모든 결정자가 후보키 집합에 속해야 한다.

* 한 테이블에 학생번호, 과목, 지도교수 컬럼이 있고, 학생번호, 과목이 기본키 일때 기본키로 지도교수를 알 수 있지만

* 지도교수로 과목 칼럼을 알 수 있다.

* 이처럼 후보키 집합이 아닌 칼럼이 결정자가 되어버린 상황을 BCNF를 만족하지 않는다고 한다.

* 학생번호, 지도교수 테이블과 지도교수, 과목의 테이블로 나누면 BCNF를 만족한다. 

#### 제4 정규형 (4NK)

#### 제5 정규형 (5NK)
