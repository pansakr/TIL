### 교착 상태(Dead Rock)

* 여러 프로세스나 스레드가 서로의 자원을 해제하기를 기다리고 있어 아무도 자원을 얻지 못해 작업이 멈추는 상태

    - A 프로세스는 C 자원을 할당받은 채 D 자원의 사용이 끝나길 기다리고 있고, B 프로세스는 D 자원을 할당받은 채 C 자원의 사용이 끝나길 기다리고 있는 상태

### 교착 상태 발생 조건

* 상호 배제, 점유와 대기, 비선점, 원형 대기 가 있다

* 상호 배제

    - 자원을 한번에 하나의 프로세스만 이용 가능한 것

* 점유와 대기

    - 자원을 할당받은 상태에서 다른 자원을 할당받기를 기다리는 상태

* 비선점

    - 자원을 이용하는 프로세스의 작업이 끝나야 이용 가능한 것

* 원형 대기

    - 프로세스들이 원의 형태로 자원을 대기하는 것

### 교착 상태 해결 방법

* 예방, 회피, 검출 후 회복 이 있다

* 예방

    - 4가지의 교착 상태 발생 조건 중 하나를 충족하지 못하게 하는 방법

    - 상호 배제 제거
    
        - 프로세스가 모든 자원을 공유하기 때문에 현실적으로 어렵다

    - 점유와 대기 제거
    
        - 운영체제는 한 프로세스에게 자원을 몰아주고, 그 다음 다른 프로세스에게 몰아주는데 이는 자원이 필요해도 기다릴수 밖에 없는 프로세스와 사용하지 않으면서 오랫동안 할당되는 자원을 많이 양산해서 자원의 활용율이 낮아진다

    - 비선점 제거
    
        - cpu와 같은 일부 자원에 대해서는 효과적이다

        - 하지만 프린터와 같은 한번에 하나의 프로세스만 이용 가능한 자원에는 적용이 불가능해 범용성이 떨어진다

    - 원형 대기 제거

        - 모든 자원에 번호를 붙여 오름차순으로 할당한다

        - 앞선 3가지 방법중 비교적 현실적이고 실용적인 방식이다

        - 그러나 모든 자원에 번호를 붙이는 작업이 간단한 일이 아니고, 어떤 번호를 붙이느냐에 따라 특정 자원의 활용율이 떨어질 수 있다

* 회피

    - 교착 상태가 발생하지 않을 정도로만 자원을 할당하는 방법

    - 안전 상태, 불안전 상태, 안전 순서열이 있다

    - 안전 상태

        - 교착 상태가 발생하지 않고 모든 프로세스가 정상적으로 자원을 할당받고 종료될 수 있는 상태

        - 안전 순서열대로 프로세스들에 자원을 배분한 상태

    - 불안전 상태

        - 교착 상태가 발생할 수도 있는 상황

        - 안전 순서열이 없는 상황

    - 안전 순서열

        - 교착 상태 없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서

        - A, B, C 프로세스가 동시에 자원을 요청한 상황에서 A -> B -> C 순서대로 자원을 할당하면 교착 상태가 발생하지 않는다고 가정할 때 A -> B -> C 는 안전 순서열이 된다

        ```
        // 안전 순서열 예시

        // 공유 자원은 12개가 있고, A, B, C 3개의 프로세스가 실행중이며, 각각 5, 2, 2 의 자원을 할당받아 사용중이고, 이들은 최대 10, 4, 9 의 자원을 요청할 수 있다고 가정

        1. 현재 할당한 자원은 9, 남은 자원은 3이며 현재 상태는 B -> A -> C 라는 안전 순서열이 있다

        2. 프로세스들이 모두 최대로 요구한다면 안전 순서열에 따라 자원을 배분한다

        3. B 가 자원 2개를 추가로 요청(B의 최대 요청수 4)시 두개를 배분해 할당한 자원 11, 남은 자원 1

        4. B가 작업을 끝내고 자원을 반환해 할당한 자원 7, 남은 자원 5

        5. A가 자원 5개 추가 요청(A의 최대 요청수 10)시 5개를 배분해 할당한 자원 12 남은 자원 0

        6. A가 작업을 끝내고 자원을 반환해 할당한 자원 2 남은 자원 10

        7. 이후 C에게 자원 배분
        ```

        ```
        // 불안전 상태

        // 위와 동일한 상황에서 C에 자원을 하나더 배분한 상황

        1. 프로세스들이 모두 최대로 요구하면 B에게 2개를 배분해 B 가 작업 종료 후 자원을 반환해도 자원 4개로는 A, B 의 요청 모두 들어줄 수 없다

        2. A와 C는 서로가 보유하고 있는 자원을 무한정 기다리게 된다 
        ```

* 교착 상태 검출 후 회복

    - 교착 상태 발생 시 사후에 조치하는 방식

    - 프로세스들이 자원을 요구할 때마다 그때그때 모두 할당하며 교착 상태 발생 여부를 주기적으로 검사한다

    - 교착 상태가 발생하면 선점을 통한 회복, 프로세스 강제 종료를 통한 회복 으로 교착 상태를 회복한다

    - 선점을 통한 회복

        - 교착 상태가 해결될 때까지 한 프로세스씩 자원을 몰아주는 방법

    - 프로세스 강제 종료를 통한 회복

        - 교착 상태가 없어질 때가지 한 프로세스씩 강제 종료하거나 교착 상태에 놓인 프로세스를 모두 강제 종료하는 방법
