### IP의 한계

* 신뢰할 수 없는 프로토콜, 비연결형 프로토콜이다

* 신뢰할 수 없는 통신

    - 패킷이 수신지가지 제대로 전송되었다는 보장을 하지 않는 통신 특성

    - 통신 과정에서 패킷의 데이터가 손상되거나 중벅된 패킷이 전송되었어도 확인하지 않고, 재전송도 하지 않으며 순서대로 패킷이 도착할 보장을 하지 않는다

* 비연결형 프로토콜

    - 송수신 호스트 간에 사전 연결 수립 작업을 거치지 않는 통신 특성

* IP 프로토콜이 이러한 특징을 가지는 이유는 성능 때문이다

* 모든 패킷의 전송 여부를 확인하고, 호스트 간에 연결을 수립하는 작업은 패킷의 빠른 송수신을 방해하므로 성능상 악영향으로 이어진다

* 하지만 금융 서비스는 반드시 신뢰성 있는 전송을 보장해야 하지만 동영상 스트리밍 서비스는 한두 개의 패킷 손실을 감수하더라도 빠른 전송이 우선 되는 것처럼 신뢰성 있는 전송이 모든 경우에 필요한 것은 아니다

### 전송 계층

* 신뢰할 수 있는 연결형 통신이 가능한 프로토콜을 제공하고 포트를 통해 애플리케이션을 식별한다

* 전송 계층의 연결형 프로토콜 TCP는 연결형 통신, 신뢰성 있는 통신을 가능하게 한다

* 전송 계층의 또다른 프로토콜 UDP는 비연결성 통신, 신뢰성할수 없는 통신을 하지만 TCP 보다 빠른 전송이 가능하다

* 포트

    - 응용 계층의 애플리케이션 프로세스를 식별할 수 있는 정보

    - 네트워크 외부에서 내 컴퓨터로 어떤 패킷이 도착했을때 이 패킷은 실행 중인 특정 애플리케이션 프로세스까지 전달되어야 한다

    - 패킷의 최종 수신 대상은 특정 애플리케이션 프로세스로, 패킷에는 특정 애플리케이션을 식별할 수 있는 정보가 있어야 하는데 이를 '포트'라고 한다

    - 포트 번호는 16비트로 표현 가능하며, 사용 가능한 포트의 수는 2의 16제곱 개이다

        - 포트는 0 ~ 65535 까지 있으며 인터넷 할당 번호 관리 기관이 포트 번호별로 애플리케이션을 할당한다

        - 0 ~ 1023 까지의 포트 번호는 잘 알려진 포트라고 하며, 시스템 포트라고 부르기도 한다

            - 범용적으로 사용되는 애플리케이션 프로토콜이 사용하는 포트 번호를 의미한다

            - ex) 53 : DNS, 67, 68 : DHCP, 80 : HTTP, 443 : HTTPS

        - 1024 ~ 49151 까지는 등록 포트 번호다

            - 잘 알려진 포트에 비해서는 덜 범용적이지만 흔히 사용되는 애플리케이션 프로토콜에 할당하기 위해 사용한다

            - ex) 1194 : OpenVPN, 3306 : MYSQL DB, 6379 : Redis, 8080 : HTTP 대체

        - 49152 ~ 65535 까지는 동적 포트, 사설 포트, 임시 포트라고 부른다

            - 인터넷 할당 번호 관리 기관에 의해 할당된 애플리케이션 프로토콜이 없고, 특별히 관리되지 않는 포트 번호인 만큼 자유롭게 사용할 수 있다

    - IP 주소와 포트 번호에 대한 정보가 함께 주어지면 특정 호스트에서 실행 중인 특정 애플리케이션 프로세스를 식별할 수 있다


### TCP

* 신뢰할 수 있는 통신을 위한 연결형 프로토콜

* 연결 수립 -> 데이터 송수신 -> 연결 종료 의 과정을 거친다

* 네트워크 계층의 IP 패킷에서 IP 헤더를 빼면 전송 계층에서 사용하는 TCP 세그먼트의 헤더, 페이로드가 남는다

    - 그 중 페이로드를 MSS 라고 하는데, 이는 TCP로 전송할 수 있는 최대 페이로드의 크기를 의미한다

    - 즉 세그먼트는 MSS 단위로 전송된다

* 세그먼트

    - TCP 프로토콜 사용 시 전송 계층에서 사용되는 데이터 전송 단위

    - 상위 계층인 응용 계층으로부터 데이터를 받아 나누고, 나눈 데이터에 송신자/수신자 포트 정보, 오류 검출 정보 등의 헤더를 추가한 것이 세그먼트다

* TCP 세그먼트의 헤더 구조

    - 송신지/수신지 포트

        - 송신지/수신지 애플리케이션을 식별하는 포트 번호가 명시되는 필드

    - 순서 번호

        - 송수신되는 세그먼트의 올바른 순서를 보장하기 위해 세그먼트 데이터의 첫 바이트에 부여되는 번호

        - ISN : 3-way 핸드셰이크 과정에서 송신자가 무작위로 생성하여 사용하는 첫 번째 순서 번호

        - ISN이 순서 번호의 시작점이다

    - 확인 응답 번호

        - 상대 호스트가 보낸 세그먼트에 대한 응답으로, 다음으로 수신하기를 기대하는 순서 번호가 
        
        - 수신한 순서 번호 + 1 이 된다

        - 예를 들어 수신한 순서 번호가 100 이라면 확인 응답 번호를 101로 명시한 세그먼트를 전송하게 된다 

    - 제어 비트

        - 플래그 비트 라고도 부르며 현재 세그먼트에 대한 부가 정보를 나타낸다

        - 8비트로 구성되며 각 자리의 비트는 다른 의미른 가진다

            - ACK : 세그먼트의 승인을 나타내기 위한 비트

            - SYN : 연결을 수립하기 위한 비트

            - FIN : 연결을 종료하기 위한 비트

    - 윈도우

        - 수신 윈도우의 크기가 명시됨

        *윈도우 : 한 번에 수신하고자 하는 데이터의 
        
    - 순서 번호와 확인 응답 번호는 TCP의 신뢰성을 보장하기 위해 사용하는 중요한 필드이다

    - 세그먼트가 전송되는 과정
        
        ```
        // 세그먼트 전송 예시

        // 4 ~ 6 번은 연결을 위한 3 - way 핸드셰이크 과정 

        1. 전송 계층이 응용 계층으로부터 1900바이트 크기의 데이터를 전달받음

        2. 이는 MSS 단위로 전송될 수 있고, MSS가 500바이트 라고 가정했을때 500, 500, 500, 400 크기의 세그먼트로 나뉜다.

        3. 세그먼트들을 순서대로 A, B, C, D 라고 부르기로 가정한다

        4. 데이터를 보내기 전 연결 수립을 위해 수신지에 무작위로 설정된 초기 순서 번호(ISN)와 SYN 플래그가 1 로 설정된 실제 데이터가 포함되지 않은 세그먼트를 보낸다

        5. 연결 수립을 위한 세그먼트를 받은 수신지는 승인을 나타내는 비트인 ACK 플래그를 1로 설정하고, 받은 세그먼트의 초기 순서 번호(ISN)에 송신받은 세그먼트의 바이트(1)를 더한 값을 확인 번호로 하는 세그먼트를 응답한다

        5.1 연결 수립을 위한 세그먼트의 크기가 1바이트기 때문에 ISN 에 +1 을 더하는 것이다

        6. 송신지는 받은 세그먼트의 ISN +1 한 값을 확인 번호로 설정하고 ACK 플래그를 1로 설정한 세그먼트를 수신지로 보낸다(연결 수립 마지막 절차)

        7. 연결 수립 이후 송신지에서 데이터를 송신하는 동안 순서 번호는 초기 순서 번호 + 송신한 바이트가 된다

        8. 세그먼트 A, B, C, D 는 각각 500, 500, 500, 400 바이트 이고, 초기 순서 번호를 100이라고 가정하면 A의 순서 번호는 초기 순서 100 과 연결 수립을 위해 보낸 SYN 이 1로 설정된 세그먼트의 크기(1 바이트) 를 더한 101이다
        
        9. B의 순서 번호는 601, C는 1101, D는 1501이 된다
        ```

* 연결 수립 - 쓰리 웨이 핸드셰이크

    - 이름처럼 세 단계로 이루어진 TCP의 연결 수립 과정

        - 1. 송신지 -> 수신지 : SYN이 1, 무작위 ISN, 송신지의 초기 순서 번호가 설정된 세그먼트 

        - 2. 수신지 -> 송신지 : SYN과 ACK이 1, 수신한 세그먼트의 ISN 에 +1 한 확인 응답 번호 값, 수신지의 초기 순서 번호가 설정된 세그먼트

        - 3. 송신지 -> 수신지 : ACK가 1, 수신한 세그먼트의 ISN 에 + 1 한 확인 번호 응답 값

    - 연결을 시작하는 호스트의 연결 수립 과정을 '액티브 오픈'이라고 한다

        - 주로 클라이언트가 액티브 오픈을 수행하고 액티브 오픈 호스트 라고도 한다

    - 연결 요청을 받고 나서 연결을 수립해 주는 호스트의 연결 수립 과정을 '패시브 오픈'이라고 한다

        - 주로 서버가 패시브 오픈을 수행하고 패시브 오픈 호스트 라고도 한다

* 연결 종료 - 포 웨이 핸드셰이크

    - 네 단계로 이루어진 TCP의 연결 종료 과정

    - 데이터 송수신이 끝나면 포 웨이 핸드셰이크를 통해 연결을 종료한다

* TCP 상태

    - TCP는 연결형 통신과 신뢰할 수 있는 통신을 유지하기 위해 상태를 유지한다

        - 여기서 상태란 현재 어떤 통신 과정에 있는지 나타내는 정보이다

        - CLOSED 
        
            - 연결이 없는 상태

        - LISTEN

            - 연결 대기 상태

            - 서버로서 동작하는 패시브 오픈 호스트가 이 상태를 유지한다

            - 연결 요청이 들어오면 쓰리 웨이 핸드셰이크가 시작된다

### UDP

* 비연결형 통신을 수행하는 신뢰할 수 없는 프로토콜

* 연결 수립 및 해제, 오류 제어 등을 수행하지 않고 상태를 유지하지도 않는다

* 데이터그램

    - UDP 프로토콜 사용 시 전송 계층에서 사용되는 데이터 전송 단위

* UDP 데이터그램 헤더

    - 송신지/수신지 포트

    - 길이

        - 헤더를 포함한 UDP 데이터그램의 바이트

    - 체크섬

        - 전송 과정에서 오류가 발생했는지 검사하기 위한 필드

        - 수신지는 이 필드의 값을 토대로 데이터그램의 정보가 훼손되었는지 판단하고, 문제가 있다고 판단한 데이터그램은 폐기한다

        - 데이터그램이 훼손되었는지만 나타내는 정보라서 '수신지까지 잘 도착했는지' 를 나타내는 신뢰성/비신뢰성과는 관계가 없다

- TCP에 비해 전송 속도가 빠르기 때문에 실시간 스트리밍, 인터넷 전화처럼 실시간성이 강조되는 상황에서 많이 쓰인다
