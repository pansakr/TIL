### 데이터 링크 계층의 한계

* 물리 계층과 데이터 링크 계층만으론 다른 네트워크까지 도달 경로를 파악하기 어렵다

    - 어떤 LAN 에 속한 호스트가 다른 LAN 에 속한 호스트와 정보를 주고받으려면 패킷이 최적의 경로로 이동해야 하고, 이렇게 패킷이 이동할 최적의 경로를 결정하는 것을 라우팅 이라고 한다

    - 물리 계층과 데이터 링크 계층의 장비로는 라우팅을 수행할 수 없고, 네트워크 계층의 장비로 가능하다

    - 라우팅을 수행하는 대표적인 장비로 라우터가 있다

* MAC 주소만으로 모든 네트워크에 속한 모든 호스트의 위치를 특정하기 어렵다

    - 모든 호스트가 수많은 LAN 그룹에 속한 모든 호스트의 MAC 주소를 알고 있기란 불가능에 가깝다

    - 스위치가 MAC 주소 테이블을 가지고 있지만, 모든 스위치들이 서로의 MAC 주소 테이블을 알게 만드는 것은 현실적으로 불가능하다

    - LAN을 넘어서 통신을 하려면 수신지 역할을 하는 네트워크 계층의 IP 주소가 필요하다

        - 택배로 비유하면 개인 정보인 수신인이 MAC 주소이고, 수신지 역할이 IP 주소이다

        - 택배 배송 과정에서 수신인, 수신지 모두를 활용하는 것처럼 네트워크도 MAC 주소와 IP 주소를 함께 사용한다
    
* 물리 계층과 데이터 링크 계층만으론 네트워크 간 통신이 어렵고, 네트워크 계층이 다른 네트워크와의 통신을 가능하게 한다

### 인터넷 프로토콜(IP - Internet Protocol)

* 물리, 데이터 링크 계층의 한계를 극복하는 네트워크 계층의 핵심적인 프로토콜

* IP 주소는 네트워크 상에서 개별 장치(컴퓨터, 서버 등)를 식별하기 위한 주소이다

* IPv4, IPv6의 두가지 버전이 있고 일반적으로 IP를 이야기할 땐 IPv4를 의미한다

    - IPv4의 주소는 .을 기준으로 8비트(0~255)범의 안의 4개의 10진수로 표현된다

    - ex) 192.168.1.1 -> .을 기준으로 각각의 숫자 범위는 8비트다

* IP 프로토콜은 크게 IP 단편화와 IP 주소 지정 기능을 한다

    - IP 주소 지정 기능

        - IP 주소를 바탕으로 송수신 대상을 지정하는 것

    - IP 단편화

        - 전송하고자 하는 패킷의 크기가 MTU라는 최대 전송단위보다 클 경우 이를 MUT 크기 이하의 여러 패킷으로 나누는 것

        *MUT : 한번에 전송 가능한 IP 패킷의 최대 크기. 헤더도 포함된다

* 패킷

    - 네트워크 계층에서 사용되는 데이터 전송 단위
 
    - 상위 계층인 전송 계층으로부터 세그먼트를 받아 IP 주소 정보 등의 헤더를 추가한 것이 패킷이다

* IPv4 패킷의 정보

    - 패킷은 프레임의 페이로드로서 데이터 필드에 명시된다

    - 하위 계층은 상위 계층으로부터 받은 패킷을 페이로드로 간주해 헤더나 트레일러를 붙인다
    
    - 데이터 링크 계층은 네트워크 계층으로부터 받은 패킷을 페이로드로 삼아 헤더와 트레일러를 붙인다

    - <img src="https://github.com/user-attachments/assets/915a12aa-16ec-4c24-82a1-b68841d0ad20">

    - 식별자

        - 패킷에 할당된 번호

        - 메시지 전송 과정에서 패킷이 여러 조각으로 쪼개져서 전송되었을때 수신지에서 재조합해야 한다

        - 이때 어떤 메시지에서부터 쪼개졌는지 인식하기 위해 식별자를 사용한다

    - 플래그

        - 세개의 비트로 구성된 필드

        - 첫번째 비트는 항상 0으로 사용되지 않는다

        - 나머지 둘 중 DF라는 이름의 비트로 IP 단편화 가능 여부를 나타낸다. 1이라면 IP단편화를 수행하지 않고, 0이라면 IP 단편화가 가능하다

        - 다른 하나는 MF라는 비트로 단편화된 패킷이 더 있는지 나타낸다. 0이라면 마지막 패킷, 1이라면 쪼개진 패킷이 더 있다는 것을 의미한다

    - 단편화 오프셋

        - 패킷이 단편화 되기 전에 패킷의 초기 데이터로부터 몇 번째로 떨어진 패킷인지 나타낸다

        - 단편화되어 전송되는 패킷들은 수신지에 순서대로 도착하지 않을 수 있어서 수신지가 패킷들을 순서대로 조합하려면 단편화된 패킷이 초기 데이터에서 몇 번째 데이터에 해당하는지 알아야 한다

    - TTL

        - 패킷의 수명을 의미한다

        - 패킷이 하나의 라우터를 거칠 때마다 TTL이 1씩 감소하며 TTL이 1이 된 패킷은 폐기된다

        - 무의미한 패킷이 네트워크상에 지속적으로 남아있는 것을 방지한다

    - 프로토콜

        - 상위 계층의 프로토콜이 무엇인지 나타내는 필드

        - 예를 들어 TCP는 6번, UDP 는 17번이다

    - 송/수신지 IP 주소

        - 이름 그대로 송/수신지의 IP 주소가 담겨있는 필드

* IPv6

    - IPv4 주소의 고갈로 등장한 주소

        - IPv4의 개수는 43억으로 쉽게 고갈될 수 있다

        - IPv6는 16바이트로 주소를 표현할 수 있고 : 으로 구분된 8개의 16진수로 표기된다

        - 이론적으로 무한에 가까운 개수를 할당할 수 있다

    - IPv6 패킷의 정보

        - 다음 헤더

            - 상의 계층의 프로토콜을 가리키거나 확장 헤더를 가리킨다

        - 홉 제한

            - IPv4의 TTL과 비슷하게 패킷의 수명을 나타내는 필드

        - 송/수신지 IP 주소

            - 이름 그대로 송/수신지 IP 주소

* ARP

    - IP 주소를 통해 MAC 주소를 알아내는 프로토콜

        - 통신 과정에서 상대 호스트의 IP 주소는 알지만 MAC 주소를 모를때 사용한다

    - ARP 동작 과정

        - ARP 요청

            - 네트워크 내의 모든 호스트에게 브로드캐스트 메시지를 보낸다

        - ARP 응답

            - 수신지를 제외한 나머지 호스트는 자신의 IP주소가 아니므로 이를 무시한다

            - 수신지의 호스트는 자신의 MAC 주소를 담은 메시지를 브로드캐스트 메시지를 보낸 송신자에게 전송한다

            - 이 메시지는 APR 패킷이고 이를 수신한 송신자는 수신지의 MAC 주소를 알게 된다

            - 데이터 링크 계층의 스위치가 MAC 주소를 학습했다고 해서 호스트들끼리 MAC 주소를 학습하는 것은 아니다(네트워크 2 스위치 설명 참조)

        - ARP 테이블 갱신

            - ARP를 활용할 수 있는 호스트들은 APR 테이블 이라는 정보를 유지한다

            - 이는 IP 주소와 그에 맞는 MAC 주소를 대응한 테이블이다

            - 이 정보로 송신자는 이전과 동일한 수신지와 통신할 때 브로드캐스트로 ARP 요청을 보낼 필요가 없어진다

            - 일정 시간이 지나면 ARP 테이블은 삭제된다

        - APR 을 사용해 다른 네트워크의 호스트가 통신하는 과정

            - 호스트 A가 속한 LAN, A가 속한 LAN과 연결된 라우터 AA, 호스트 B가 속한 LAN, 호스트 B가 속한 LAN과 연결된 라우터 BB, 라우터 AA, BB 끼리 연결되어 있다고 가정

            - A가 B에게 패킷을 보내려면 우선 자신이 속한 LAN 과 연결된 라우터 AA 에게 패킷을 보내야 한다

            - 만약 A가 라우터의 MAC 주소를 모른다면 APR 프로토콜로 라우터 AA의 MAC 주소를 얻어 와서 이를 향해 패킷을 전송한다

            - 라우터 AA는 패킷의 주소를 보고 최적의 경로를 찾아 자신과 연결된 라우터 BB에게 패킷을 전송한다

            - 라우터 AA가 라우터 BB의 MAC 주소를 모른다면 ARP 프로토콜을 거쳐 BB에게 패킷을 전송한다

            - 라우터 BB는 호스트 B에게 패킷을 전달하는데 MAC 주소를 모른다면 똑같이 ARP 프로토콜을 거쳐 MAC 주소를 얻어와 전송한다

* 네트워크 주소와 호스트 주소

    - 네트워크 통신에서 IP 주소와 MAC주소를 함께 사용하지만 IP 주소를 기본으로 사용한다

    - 하나의 IP 주소는 네트워크 주소와 호스트 주소로 이루어져 있다

    - 네트워크 주소는 호스트가 속한 특정 네트워크를(주로 LAN) 식별하고, 호스트 주소는 네트워크 내에서 특정 호스트를 식별한다

        - 192.162.1.1 에서 .으로 구분된 8비트 범위의 십진수 4개를 하나 하나를 옥텟이라 한다 

        - 만약 네트워크 주소가 하나의 옥텟으로 이루어져 있다면 호스트 주소에 나머지 3옥텟을 사용할 수 있어서 상대적으로 많은 호스트에 IP 주소를 할당할 수 있다

        - 네트워크 주소가 3개의 옥텟으로 이루어져 있다면 호스트 주소에 하나의 옥텟을 사용할 수 있으니 상대적으로 적은 호스트에 IP 주소를 할당할 수 있다

        - 네트워크 주소와 호스트 주소의 적당한 크기를 찾기 위해 클래스풀 주소 체계를 사용한다

    - 클래스풀 주소 체계

        - 네트워크 크기에 따라 IP 주소를 분류하는 클래스를 기반으로 한 IP 주소 체계

        - A ~ E 까지 있지만 실질적으로는 A, B, C 만 사용된다

        - 각 클래스마다 네트워크 주소와 호스트 주소의 개수가 정해져 있어서 이들의 개수를 맞춘 네트워크를 구성하기 어렵다

        - 현재 사용되지 않는 방식이다

        - A클래스

            - 1옥텟을 네트워크 주소, 3옥텟을 호스트 주소로 구성하는 방법

            - A클래스의 네트워크 주소는 비트 0으로 시작하기 때문에 2의 7제곱(128) 만큼의 네트워크 주소를 가질 수 있다

            - 나머지 3옥텟 만큼인 2의 24제곱 비트만큼(16,777,216) 호스트 주소를 가질 수 있다

                - 만약 100 개의 호스트가 있는 T 라는 이름의 네트워크에 120.0.0.0 의 A 클래스 주소를 할당하면 T 네트워크의 주소는 120.0.0.0 이고, 호스트 주소 범위는 120.0.0.1 ~ 120.255.255.254 이다
            
                - 여기서 단 100개만 사용하는 것이니 약 16,777,116 만큼의 호스트 주소의 낭비가 있는 것이다

                - 그리고 T 네트워크에서 120 으로 시작하는 A 클래스 주소를 사용했으니 다른 네트워크에선 120.0.0.0 ~ 120.255.255.255 범위의 주소를 사용하지 못하기 때문에 T 네트워크에서 낭비한 주소들은 영원히 사용되지 않게 된다


        - B클래스

            - 네트워크 주소, 호스트 주소에 2옥텟씩 구성하는 방법 

            - B클래스의 네트워크 주소는 비트 10으로 시작하기 때문에 2자리를 뺀 2의 14제곱 만큼의 네트워크 주소를 가질 수 있다


        - C클래스

            - 네트워크 주소 3옥텟, 호스트 주소 1옥텟으로 구성하는 방법

            - C클래스의 네트워크 주소는 110으로 시작하기 때문에 3자리를 뺀 2의 21제곰 만큼의 네트워크 주소를 가질 수 있다


    - 클래스리스 주소 체계

        - 서브넷 마스크로 네트워크 주소와 호스트 주소를 구분하고, 어떤 서브넷 마스크를 적용하느냐에 따라 호스트 주소 범위를 정할 수 있는 IP 주소 체계

        - 클래스풀 주소와 달리 네트워크/호스트 주소 영역을 유동적으로 구성할 수 있다
     
        - 클래스풀 주소 체계에서 낭비되는 호스트 주소를 막기 위해 사용되기 시작했다

        - IP 주소 형식은 같지만, 서브넷 마스크로 네트워크/호스트 주소를 구분한다

            - 192.168.0.1 처럼 IP 주소 형식은 같다 (주소 체계가 같다는 소리 x)

            - 여기에 어떤 서브넷 마스크를 적용하느냐에 따라 네트워크/호스트 주소 개수를 정할수 있다


            - 서브넷

                - 네트워크를 분할해 더 작은 네트워크로 나눈 것

                - 어떤 IP 주소를 서브넷 마스크로 나누어서 나온 IP의 범위(호스트 주소 범위)가 서브넷이다

                - 네트워크 크기는 일반적으로 네트워크가 할당받은 IP 주소의 수에 따라 정의된다

                - 고정 단위인 클래스풀 주소 체계와 다르게 호스트 수에 맞춰 네트워크 크기를 구성할 수 있다

                - 네트워크를 나누는 것을 서브네팅이라고 한다

                - 서브넷 마스크를 통해 서브네팅을 수행한다

            - 서브네팅

                - ip 주소를 서브넷 마스크를 사용해 더 작은 네트워크로 나누는 것

                - IP 주소와 서브넷 마스크를 비트 AND 연산하면 서브넷이 나온다

                - 비트 AND 연산 결과가 서브넷의 네트워크 주소이며 연산에 사용된 서브넷 마스크의 비트0의 개수가 호스트 주소 범위이고 서브넷의 마지막 주소는 브로드 캐스트 주소이다

                ```
                // 서브넷의 주소 범위

                1. 192.168.94.0/26 의 경우 서브넷은 /26 이므로 26비트가 네트워크,6비트가 호스트를 나타낸다

                2. IP 주소와 서브넷을 비트 AND 연산해 서브넷을 구한다
                
                3. 192.168.94.0 을 2비트로 변환하면 11000000.10101000.01011110.00000000 이다

                4. /26은 1이 26개 이므로 11111111.11111111.11111111.11000000 이다

                5. 둘을 비트 AND 연산하면 1100000000.10101000.01011110.00000000 이다

                6. 이를 10진수로 바꾸면 192.168.94.0 이고 이 주소가 네트워크 주소이다

                7. 해당 네트워크 주소로 할당 가능한 호스트 주소 범위는 연산에 사용된 서브넷 마스크의의 0의 개수인 6비트(64개) 만큼이다

                8. 그런데 첫 주소는 네트워크 주소이고, 마지막 호스트 주소는 브로드 캐스트 주소이므로 62개이다

                9. 즉 192.168.94.0 에서 할당 가능한 호스트 주소 범위는 192.168.94.1 ~ 192.168.94.62 이다
                ```


            - 서브넷 마스크

                - 네트워크 주소와 호스트 주소를 구분하기 위한 비트 패턴

                - 구성하려는 호스트 주소 개수에 따라 다른 서브넷 마스크를 사용한다

                - 255.255.255.0 등의 형태이고 이를 2비트로 바꿨을때 1 의 개수만큼의 비트가 네트워크 주소의 범위, 0의 개수만큼의 비트가 주소 범위이다

                ```
                // 서브넷 마스크 255.255.255.0 예시

                1. 비트로 바꾸면 11111111.11111111.11111111.00000000 이다

                2. 1의 개수는 24개고 24비트 만큼의 네트워크 주소를 가질 수 있다

                3. 0의 개수는 8개고 8비트 만큼의 호스트 주소를 가질 수 있다

                4. 즉 255.255.255.0 서브넷 마스크는 8비트(255) 만큼의 호스트 주소가 필요할 때 사용하는 서브넷 마스크다
                ```

                - 서브넷 마스크 표기법 CIDR

                    - IP 주소 / 서브넷 마스크의 1의 개수 형식으로 표기하는 방법

                    - 서브넷 마스크 255.255.255.0 은 1이 24개니 /24로 표기하고 여기에 IP 주소를 더해 192.168.1.0 /24 로 표기한다

                    - /25 는 1이 25개, /26은 1이 26개 라는 뜻이고, 1은 네트워크 주소를 말하는 것이니 /25는 25비트의 네트워크 주소 범위와 7비트의 호스트 주소 범위를 뜻하는 것이다

                    - 예를 들어 호스트 주소 개수가 적게 필요하면 /26, /27 처럼 작은 서브넷 마스크를 사용하는 것이고, 많이 필요하다면 /20, /19 처럼 필요한 만큼의 서브넷 마스크를 사용하면 된다

### 사설 IP 주소와 공인 IP 주소

* 공인 IP 주소

    - 전 세계에서 고유한 IP 주소

    - 인터넷을 이용할 때 사용하는 IP 주소가 공인 IP 주소이다

* 사설 IP 주소

    - 사설 네트워크에서 사용하기 위한 IP 주소

    *사설 네트워크 : 외부 네트워크에 공개되지 않은 네트워크

    - 사설 IP 주소의 할당 주체는 라우터로 해당 호스트가 속한 사설 네트워크에서만 유효하다

    - 그렇기 때문에 다른 네트워크상의 사설 IP 주소와 중복될 수 있다

    - LAN 내의 대부분의 호스트는 사설 IP 주소를 사용하고, 일반적으로 개인 컴퓨터나 노트북 같은 장치들도 사설 IP 주소를 사용한다

    - 사설 IP 주소를 가진 패킷이 외부 네트워크로 전송될 때는 NAT에 의해 공인 IP 주소로 변경된다 

    - NAT(Network Address Translation)

        - 사설 IP 주소를 공인 IP 주소로 변환하는 기술

        - 사설 IP 주소는 해당 호스트가 속한 네트워크 내부에서만 사용할 수 있어서 사설 IP 주소를 가진 패킷이 외부 네트워크로 전송되려면 외부 네트워크에서 사용할 수 있는 공인 IP 주소가 필요하다

        - 라우터, 공유기 는 NAT 기능을 내장하고 있다

        - 사설 IP 주소를 가진 패킷이 라우터의 NAT 기능으로 공인 IP주소로 변경되어 외부 네트워크로 전송되고, 반대로 외부 네트워크로부터 공인 IP 주소를 가진 패킷이 오면 라우터가 사실 IP 주소로 바꿔 내부 네트워크로 전송한다

### 정적 IP 주소와 동적 IP 주소

* 정적 할당

    - 사용자가 호스트에 수작업으로 IP 주소를 부여하는 방식

    - 윈도우나 맥 등의 운영체제에서 네트워크 설정을 확인해 보면 IP 주소를 수동으로 설정할 수 있는 항목이 있다

    - 부여하고자 하는 IP 주소, 서브넷 마스크, 게이트웨이(일반적으로 라우터) 주소, DNS 주소를 입력하게 되어있다

    *게이트웨이 : 서로 다른 네트워크를 연결하는 하드웨어적 수단. 그중 기본 게이트웨이는 호스트가 속한 네트워크 외부로 나가기 위한 첫 번째 경로를 의미한다. 그래서 기본 게이트웨이는 네트워크 외부와 연결된 라우터의 주소를 의미하는 경우가 많다

* 동적 할당

    - 주소를 일일히 입력하지 않아도 호스트에 IP주소가 동적으로 할당되는 방식

    - 사용하지 않을 경우 회수되고, 할당받을 때마다 다른 주소를 받을 수 있다

    - 스마트폰이나 노트북 사용시 ip 주소를 할당하지 않고 인터넷을 사용할 수 있는 것은 IP 주소가 동적으로 할당되었기 때문이다

    - IP 동적 할당에 사용되는 대표적인 프로토콜이 DHCP 이다

        - IP 주소를 할당받고자 하는 호스트와 해당 호스트에게 IP주소를 제공하는 DHCP 서버간에 메시지를 주고받으면서 이루어진다

        - DHCP 서버는 라우터가 수행한다

        - DHCP 서버는 클라이언트에게 할당 가능한 IP 주소 목록을 관리하다가 클라이언트가 요청 시 IP 주소를 할당한다

        - 이때 DHCP로 할당받은 주소는 사용할 기간이 정해져 있어서 사용 기간이 끝난 IP 주소는 다시 DHCP 서버로 반납된다

### 라우터

* 패킷이 이동할 최적의 경로를 설정하고 해당 경로로 패킷을 이동시킨다 (라우팅)

* 네트워크 계층의 장비로 네트워크 계층의 핵심 기능을 담당한다

* 멀리 떨어져 있는 호스트 간의 통신에서 패킷은 서로에게 도달하기 위해 여러 라우터를 거쳐 이동한다

* 패킷이 호스트와 라우터, 라우터와 라우터 간에 이동하는 하나 하나의 과정을 홉 이라고 한다

* 라우터는 라우팅을 위해 라우팅 테이블을 참고한다

* 라우팅 테이블

    - 특정 수신지까지 도달하기 위한 정보를 명시한 표

    - 라우터는 라우팅 테이블을 참고해 수신지까지의 도달 경로를 판단한다

    - 컴퓨터, 공유기, 라우터 등은 라우팅 테이블을 가지고 있다

    - 라우팅 테이블에 명시되는 정보

        - 수신지 IP 주소와 서브넷 마스크

            - 최종적으로 패킷을 전달할 대상

        - 다읍 홉

            - 최종 수신지까지 가기 위해 다음으로 거쳐야 할 호스트의 IP 주소. 인터페이스라고 명시되기도 한다

        - 네트워크 인터페이스

            - 패킷을 내보낼 통로

        - 메트릭

            - 해당 경로로 이동하는데 드응 비용

            - 패킷을 전송할 때 리우팅 테이블에 있는 경로 중 메트릭이 낮은 경로를 선호한다 

    - 아래와 같은 라우팅 테이블이 있을때, 이는 수신지가 192.168.2.0 /24 (호스트 IP 주소 범위 192.168.2.1 ~ 192.168.2.254)인 패킷은 eth0(인터페이스) 를 통해 192.168.2.1(게이트웨이)로 전송하라는 것을 의미한다

    <img src="https://github.com/user-attachments/assets/642bee0f-ba5a-4287-91fb-80d14b78aea8">

    - 패킷 내의 수신지 IP 주소가 라우팅 테이블에 없는 경우 기본적으로 패킷을 내보낼 경로인 '디폴트 라우트'로 전송한다
    
    - 디폴트 라우트 정보는 라우팅 테이블에 수신지 IP 주소가 0.0.0.0 /0 으로 명시되어 있는 행인데 패킷의 수신지 IP가 라우팅 테이블에 없을때 이 행의 게이트웨이 주소로 패킷을 전송한다

        ```
        // 디폴트 라우트 예시

        1. A호스트가 외부 네트워크의 호스트 B 에게 패킷을 전달하려고 한다

        2. A가 패킷 전송 시 A의 장치는 라우팅 테이블을 살펴보는데 수신지 IP 주소가 없어 기본 게이트웨이로 설정된 곳(공유기)로 패킷을 보낸다

        3. 공유기는 패킷을 받아 자신의 라우팅 테이블을 확인하고 마찬가지로 수신지 IP 주소가 없어 패킷이 외부로 가야 한다는 것을 알게 된다

        4. 외부 네트워크로 나가는 경로는 라우터 지정 되어 있어서 공유기는 라우터로 패킷을 전송한다

        5. 라우터는 외부 네트워크로 나가는 관문 역할을 하며 패킷이 어떤 경로를 통해 나갈지 결정한다

        6. 라우터도 라우팅 테이블을 찾아 패킷의 적절한 전송 경로를 탐색해 전송한다   

        // 수신지 IP 주소가 없는 것은 외부 네트워크로 향하는 패킷이기 때문인데, 같은 네트워크에 속한 내 컴퓨터, 공유기는 외부 네트워크의 IP 주소 정보가 없다 
        ```

* 정적 라우팅과 동적 라우팅

    - 라우팅 테이블이 만들어지는 방식에는 정적/동적 라우팅이 있다

    - 정적 라우팅

        - 사용자가 수동으로 작성한 라우팅 테이블로 라우팅하는 방식

        - 만약 설정한 경로의 라우터 중 하나가 문제가 생겼을때 다른 경로로 우회해서 보낼 수 있더라도 수동 설정한 경로로 전송할 수밖에 없다

    - 동적 라우팅

        - 자동으로 라우팅 테이블 항목을 만들어 라우팅하는 방식

        - 라우터들은 라우팅 프로토콜을 사용해 라우팅 테이블을 동적으로 작성한다
