### 장치 컨트롤러

* 입출력 장치와 cpu가 서로 데이터를 주고받을 수 있도록 연결해주는 장치

* 메인보드에 내장되어 bus를 통해 cpu와 메모리와 연결되어 있다

* 여러 장치마다 데이터 전송 형식, 전송률이 달라 컴퓨터에 직접 연결되지 않고 장치 컨트롤러를 통해 연결된다

    *전송률 : 데이터를 얼마나 빨리 교환할 수 있는지 나타내는 지표

    - 일반적으로 cpu와 메모리의 데이터 전송률은 높지만 입출력장치의 데이터 전송률은 낮다

* 모든 입출력장치는 각자의 장치 컨트롤러를 통해 컴퓨터 내부와 정보를 주고받는다

* 장치 컨트롤러는 cpu와 입출력 장치 간 통신 중개, 오류 검출, 데이터 버퍼링 역할을 한다

* 입출력 장치 간 통신 중개, 오류 검출

    - 입출력 장치와 cpu가 데이터를 주고받을 수 있게 관리

    - 그 과정에서 연결된 입출력장치에 문제가 없는지 오류 검출

* 데이터 버퍼링

    - cpu와 입출력장치의 전송률 차이를 버퍼링으로 완화

    - 버퍼

        - 하나의 장치에서 다른 장치로 데이터를 전송할 때 서로의 데이터의 전송 속도나 처리 속도의 차이를 극복하기 위한 임시 저장 공간

    - 버퍼링

        - 전송률이 높은 장치와 낮은 장치 사이에서 주고받는 데이터를 버퍼 라는 임시 저장 공간에 모았다가 한꺼번에 내보내 전송률을 비슷하게 맞추는 방법

    - 동영상 스트리밍에서의 버퍼

        - 동영상은 영상이 진행되는 빨간색 부분, 서버로부터 동영상을 내려받은 회색부분, 아직 받지 않은 투명부분으로 구분할 수 있다.

        - 만약 동영상을 보는 속도와 데이터를 받는 속도가 같다면 동영상 시간만큼 데이터를 받아야 한다.

        - 이를 방지하기 위해 버퍼라는 임시 저장공간을 두고 동영상 데이터를 일정 부분 최대한 빠르게 받아 저장해 둔다.

        - 동영상을 보다 보면 버퍼에 동영상이 모두 다운로드 되어 있다.

        - 인터넷이 느리던 시절에는 동영상을 버퍼에 다운로드 하는 속도가 시청속도를 따라가지 못해 동영상이 멈추는 일이 있었고 이를 버퍼링 걸린다 라고 이야기했었다.

    - 입출력에서의 버퍼

        - cpu와 보조기억장치 사이에서 사용되는 임시 저장 공간

        - cpu는 빠르게 데이터를 처리할 수 있지만 보조기억장치는 데이터를 보내주는 속도가 느리다.

        - 이 경우 cpu가 아무리 빨라도 데이터를 보내주는 속도가 느리니 효율성이 매우 떨어지게 된다.

        - 그리고 타자를 빠른 속도로 입력할때 컴퓨터가 성능이나 상황에 따라 입력되는 속도에 맞춰 데이터를 입력하지 못한다면 데이터를 유실할 수 있다.

        - 이 때 버퍼를 사용하는데 버퍼는 보조기억장치보다 훨씬 빠른 주기억 장치(RAM)을 이용한다.

        - 보조기억장치가 버퍼에 데이터를 보내 임시 저장해두면 cpu가 다른 일을 처리하다가 어느정도 쌓이면 한꺼번에 가져와서 처리한다.

* 장치 컨트롤러의 내부

    - 데이터 레지스터

        - cpu와 입출력장치 사이에 주고받을 데이터가 담기는 레지스터

        - 버퍼 역할을 한다

    - 상태 레지스터

        - 입출력 장치가 입출력 작업을 할 준비가 되었는지, 입출력 작업이 완료되었는지, 오류는 없는지 등의 상태 정보가 저장되는 레지스터

    - 제어 레지스터

        - 입출력 장치가 수행할 내용에 대한 제어 정보와 명령을 저장

* 위 3가지 레지스터의 값들은 bus를 타고 cpu나 다른 입출력장치로 전달된다


#### 장치 드라이버

* 장치 컨트롤러를 동작하게 하는 프로그램

* 장치 컨트롤러는 cpu나 메모리처럼 하드웨어의 일부분이고 이를 동작시키는 프로그램이 장치 드라이버다

* 다른 제조사의 마우스마다 다른 장치 드라이버가 필요한 이유

    - 각 제조사마다 마우스의 하드웨어를 다르게 설계하기 때문이다

    - 장치 드라이버는 하드웨어와 소프트웨어 간의 소통을 가능하게 하기 위해 그 하드웨어의 구체적인 작동 방식과 특성에 맞춰 설계된다

    - 그리고 운영 체제와의 호환성을 고려하여 설계되기 때문에 다른 운영 체제 에 대해 드라이버가 다르게 작성될 수 있다


### 여러 입출력 방법들

* 입출력 작업을 수행하려면 cpu와 장치 컨트롤러가 정보를 주고받아야 한다

* 프로그램 입출력

    - 프로그램 속 명령어로 입출력장치를 제어하는 방법

    - cpu가 프로그램의 명령어를 실행하면서 입출력 명령어를 만나면 cpu는 입출력장치에 연결된 장치 컨트롤러와 상호작용해 입출력을 수행한다

    ```
    // 프로그램 입출력 순서
    // 메모리에 저장된 정보를 하드 디스크에 백업하는 상황

    1. cpu는 하드 디스크 컨트롤러의 제어 레지스터에 쓰기 명령을 보냄

    2. 하드 디스크 컨트롤러는 하드 디스크 상태를 확인 후 준비된 상태라면 상태 레지스터에 준비되었다고 표시

    3. cpu는 상태 레지스터를 주기적으로 읽으며 하드 디스크의 준비 여부를 확인

    4. 준비되었음을 cpu가 알게 되면 백업할 메모리의 정보를 데이터 레지스터에 쓴다 
    ```

    - 위 과정에서 cpu는 장치 컨트롤러의 레지스터 주소를 모르기 때문에 메모리 맵 입출력 방법을 사용하고 있다

    - ex) cpu는 하드 디스크 컨트롤러의 상태 레지스터를 읽고 싶어도 레지스터 주소를 모르기 때문에 '메모리 맵 입출력' 방법을 사용중이다

    - 메모리 맵 입출력

        - 장치 컨트롤러의 레지스터를 메모리 공간에 맵핑하는 방법

        - 컴퓨터의 메모리 공간이 1024 라면 512는 메모리, 512는 장치 컨트롤러의 레지스터를 표현하기 위해 사용한다

        - 600번지에 하드 디스크 컨트롤러의 데이터 레지스터, 700 번지에 하드 디스크 컨트롤러의 상태 레지스터를 저장한다고 가정한다

        - 600번지에 'x'를 써라 라는 명령을 내리면 메모리의 600번지에 'x'가 쓰여지고 하드 디스크 컨트롤러의 데이터 레지스터에도 기록된다

        - 그리고 cpu는 하드 디스크의 상태 레지스터를 확인하고 싶을때 700번지를 읽어라 라는 명령으로 확인할 수 있다

* 인터럽트 기반 입출력

    - cpu가 입출력장치에 처리할 내용을 명령해서 입출력장치가 명령을 수행하는 동안 cpu는 다른 일을 수행할 수 있는 방법

    - 정확히 말하면 cpu는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력장치를 제어해 입출력을 수행하는 동안 cpu는 다른 일을 할 수 있다

    - 이 방법도 장치의 레지스터에 접근하기 위해 메모리 맵 입출력 방식을 사용한다

    ```
    // 인터럽트 기반 입출력의 프린트 과정
    
    1. 사용자가 프린트 버튼을 누르면 해당 요청은 프린터 드라이버로 전달

    2. 프린터 드라이버는 적절한 프린트 명령어를(프린트를 위한 데이터 전송 요청) 생성해 cpu를 통해 장치 컨트롤러로 전달

    3. 프린터가 데이터 수신 준비 완료시 프린트 장치 컨트롤러는 인터럽트 발생

    4. cpu는 인터럽트를 확인 후 프린트 인터럽트 서비스 루틴 실행

    4.1 프린트 데이터 수신 완료의 프린트 서비스 루틴 - 프린트 상태 확인 및 데이터 전송 명령 내림

    5. cpu가 데이터를 프린트 데이터 레지스터에 전송함. dma 컨트롤러 사용 시 dma 컨트롤러가 전송 작업 수행

    6. 프린트 장치 컨트롤러는 명령을 수행해 실제 출력 작업 실행

    7. 출력 완료 후 프린트 장치 컨트롤러는 인터럽트 발생

    8. cpu는 인터럽트 확인 후 프린트 인터럽트 서비스 루틴 실행

    8.1 프린트 출력 완료의 프린트 서비스 루틴 - 프린터 상태 확인, 작업 완료 기록, 후속 작업 처리(예: 다른 인쇄 대기 작업이 있으면 이를 시작함)

    같은 입출력 요청이라도 인터럽트 발생 횟수는 시스템 설정과 하드웨어 구성별로 다르다
    ```

    - 다중 인터럽트 처리 방법

        - 보통 여러개의 입출력 장치를 사용하는데, 입출력장치들이 동시에 인터럽트 요청 시 cpu는 우선순위가 높은 인터럽트 순으로 처리한다

        - 많은 컴퓨터들은 pic 라는 장치를 사용한다

        - pic는 여러 장치 컨트롤러에 연결되어 장치 컨트롤러에서 보낸 인터럽트 요청 우선순위를 판별해 cpu에 먼저 처리해야할 하드웨어 인터럽트를 알려주는 장치이다 

        ```
        // pic 가 다중 인터럽트를 처리하는 방법

        1. pic가 여러 장치 컨트롤러에서 인터럽트 요청 신호들을 받음

        2. pic는 우선순위를 판단한 뒤 cpu에 처리해야할 인터럽트 요청 신호를 보냄

        3. cpu는 pic에 인터럽트 확인 신호를 보냄

        4. pic는 데이터 버스를 통해 cpu에 인터럽트 벡터를 보냄

        4.1 인터럽트 벡터는 cpu가 실행할 인터럽트 서비스 루틴의 주소를 저장하고 있는 메모리 주소이다

        5. cpu는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게되어 해당 장치의 인터럽트 서비스 루틴을 실행
        ```

* DMA 입출력

    - cpu를 거치지 않고 메모리와 입출력장치의 데이터를 주고받는 방식

    - 이전의 방식들은 모두 cpu 가 관여해야 해서 cpu의 부담이 크다

    - cpu가 DMA 컨트롤러에게 입출력 명령을 내리면 DMA 컨트롤러는 cpu 대신 장치 컨트롤러와 상호작용하여 입출력 작업을 수행한다

    ```
    // DMA 입출력

    1. 사용자가 메모장에 글을 작성하고 저장함

    2. 메모장 애플리케이션은 파일 저장 시스템 호출을 통해 저장 요청을 운영 체제에 전달

    3. 운영체제는 dma 컨트롤러를 설정해 데이터 전송을 준비

    3.1 dma 컨트롤러의 데이터 전송 준비과정 : cpu는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산(읽기, 쓰기), 읽거나 쓸 메모리의 주소 등의 정보를 보내 입출력 작업을 명령

    4. DMA 컨트롤러는 cpu 대신 장치 컨트롤러와 상호작용하여 입출력 작업을 수행하는데 필요한 경우 메모리에 직접 접근하여 정보를 읽거나 쓴다

    5. 작업이 끝나면 DMA 컨트롤러는 cpu에 인터럽트를 보내 작업이 끝났음을 알림
    ```

    * 그런데 DMA 컨트롤러와 cpu가 사용하는 시스템 버스는 공용 자원이라 둘이 동시에 사용할 수 없다

    * cpu가 사용중이면 DMA 컨트롤러는 사용하지 못하는데, 이것은 사이클 스틸링, 입출력 버스를 통해 해결한다

    * 사이클 스틸링

        - DMA 컨트롤러가 cpu가 시스템 버스를 이용하지 않을 때 사용하거나, cpu가 일시적으로 시스템 버스를 이용하지 않도록 하고 시스템 버스를 집중적으로 이용하는 방법

    * 입출력 버스

        - DMA 컨트롤러와 장치 컨트롤러를 입출력 버스라는 별도의 버스에 추가로 연결해 사용하는것

        - 기존의 시스템 버스에 연결된 상태는 그대로이고, DMA 컨트롤러와 장치 컨트롤러를 입출력 버스라는 별도 버스에 추가로 연결해서 둘이 데이터 전송 시 입출력 버스를 사용하게 되어 시스템 버스 사용 빈도가 줄어든다

        - 현대 대부분의 컴퓨터는 입출력 버스가 있어서 대부분의 입출력장치들은 입출력 버스를 사용한다 

        - 입출력 버스에는 PCI 등 여러 종류가 있다
