### 멀티스레드

* 여러 클라이언트들의 요청을 동시에 처리해주는 기술

* 애플리케이션 코드를 순차적으로 실행하는 것은 스레드이고, 자바에는 기본적으로 main 이라는 이름의 스레드가 있다

* 동시 처리가 필요하면 스레드를 추가로 생성해야 한다

```
// 스레드 하나 사용시 단일 요청, 다중 요청

// 단일 요청
// 요청 -> 서버 연결 -> 스레드 할당 -> 스레드가 서블릿 호출 -> 로직 실행 후 응답 -> 스레드 휴식

// 다중 요청
// 요청1 -> 서버 연결 후 스레드 할당해서 요청1 처리중 처리 지연 발생
// 이때 요청2 -> 서버 연결 후 스레드 대기
// 두 요청 모두 실패하게 된다    
```

#### 다중 요청시 스레드 해결방안

#### 요청 마다 스레드 생성

* 많은 요청이 들어와도 매번 새로운 스레드가 생성되기에 스레드를 대기할 필요가 없다

* 리소스(cpu,메모리)가 허용할 때까지 처리 가능하고, 하나의 스레드가 지연 되어도 나머지 스레드는 정상 동작한다

* 하지만 스레드의 생성 비용은 비싸기 때문에 응답 속도가 늦어진다

* 컨텍스트 스위칭 비용이 발생한다

* 스레드 생성의 제한이 없어 고객 요청이 너무 많이 오면 cpu, 메모리 임계점을 넘어 서버가 죽을 수 있다


#### 스레드 풀 사용

* 스레드를 미리 생성해 스레드 풀에 보관해놓고 클라이언트의 요청시 스레드 풀에서 스레드를 꺼내서 사용하고 완료시 다시 반납한다

* 스레드 풀에 생성 가능한 스레드의 최대치를 관리한다. 톰캣은 최대 200개가 기본 설정이다

* 최대 스레드를 모두 사용중면 특정 숫자만큼 대기하거나 아예 거절하도록 설정할 수 있다

* 스레드가 미리 생성되어 있으므로, 스레드의 생성, 종료 비용(cpu)이 절약되고, 응답 시간이 빠르다

* 생성 가능한 스레드의 최대치가 있으므로 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다


### 스레드 풀

* WAS의 주요 튜닝 포인트는 최대 스레드(max thread) 수이다

* 이 값을 너무 낮게 설정하면 동시 요청이 많을때 서버 리소스는 여유롭지만, 동시 요청 가능한 수가 적으므로 클라이언트는 금방 응답이 지연된다

* 이 값이 너무 높게 설정하면 동시 요청이 많을때 CPU, 메모리 리소스 임계점 초과로 서버가 다운된다

* 장애 발생시 클라우드 환경이라면 일단 서버부터 늘린 다음 튜닝하고, 클라우드가 아니면 튜닝을 잘해야 한다


### WAS의 멀티 스레드 지원

* 멀티 스레드에 대한 부분은 WAS가 처리한다

* 개발자는 멀티 스레드 관련 코드를 신경쓰지 않아도 되며 싱글 스레드 프로그래밍을 하듯이 소스 코드를 개발하면 된다

* 멀티 스레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)은 주의해서 사용
