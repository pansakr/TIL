### JWT 적용 환경

* API 만 사용하는 환경

    - 사용자가 로그인 성공 -> 서버가 JWT 가 발급 -> 클라이언트에게 응답

    - JWT 는 클라이언트의 메모리, 로컬 스토리지, 쿠키 등에 저장됨

    - 사용자가 버튼을 눌러 API 호출

    - JS 로 요청을 원하는 형태로 직접 만듬

    ```js
    fetch("/api/subscriptions", {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + token,   // 요청 헤더에 JWT 붙여 보냄
            "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
    })
    ```

    - 서버는 Authorization 헤더에서 토큰 꺼내 검증 -> 인증 성공하면 컨트롤러 실행

    - 요청을 만드는 주체가 JS 라서 매 요청마다 JWT 를 실어 보내는 코드를 만들기 쉬움

* SSR(Thymeleaf) 사용하는 환경

    - 사용자가 로그인 성공 -> 서버에서 JWT 발급 -> 클라이언트에게 응답

    - 사용자가 api 요청 링크를 클릭 -> 브라우저가 요청 자동 생성

    ```html
    <a href="/subscriptions">구독 목록</a>

    <!-- 브라우저가 자동 생성하는 요청 -->
    GET /subscriptions
    Cookie: ...
    ```

    - 클릭으로 발생하는 브라우저의 요청에 Authorization 헤더를 끼워 넣을 방법이 없다

    - html 에서 발생하는 모든 요청을 js 가 가로채서 요청을 만드는 방법으로 바꾸면 동작하기는 한다

        - SSR 의 장점을 포기하게 된다

        - SSR(Server-Side Rendering)

            - 서버가 데이터가 채워진 완성된 html 을 보냄으로서 브라우저가 JS 파일을 실행할 때 까지 기다릴 필요 없이 HTML 을 즉시 화면에 그린다
            
            - 빠른 초기 로딩 속도를 가짐

            - JS 를 비활성화해도 페이지 이동과 데이터 전송 가능

        - html 의 모든 요청을 JS 로 교체

            - JS 가 가로챌 경우 브라우저는 데이터가 없는 최소한의 HTML 을 받게되고, 화면을 구성하는 데이터 요청과 렌더링을 JS 가 나중에 수행하므로 SSR 의 속도 이점이 사라짐

            - 모든 요청과 서버의 응답에 대한 처리를 js 로 대응해야 해서 복잡도 증가

    - 해결 방법

        - 쿠키 사용

            - 로그인 성공 시 서버가 JWT 를 쿠키로 응답

            - 사용자가 재 요청 시 자동으로 쿠키를 붙여서 요청을 보냄

            - 서버는 쿠키에서 JWT 를 꺼내 검증

            - 하지만 CSRF 방어해야 함

        - 부분적으로 js 사용

            - 요청 전부를 js 로 대체하는 것이 아니라 특정 요청들에만 js 를 사용한다

            - 보통 화면 이동은 html form, api 는 js 를 사용

            - 따라서 api 요청 시 js 로 jwt 를 사용하도록 적용

            - 하지만 프론트 영역이 늘어남

        - API, 폼 요청 다르게 구성
        
            - API 접근 권한 만료 = JWT

                - 쿠키 기반 jwt 를 사용함으로 js 최소화

                - api 는 jwt 기반이므로 확장 대비

            - 세션 만료 = 웹 로그인 만료

                - 폼 요청을 jwt 로 하면 토큰을 재발급 받기 위한 일련의 구성이 필요함

                - 세션을 사용하는게 더 간단
