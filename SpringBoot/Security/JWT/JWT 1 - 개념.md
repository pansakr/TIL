### 토큰

* 인증 및 권한 부여과정에서 사용되는 문자열

* 인증된 사용자를 식별하고 해당 사용자의 접근 권한을 확인할 때 사용한다

* 토큰은 일반적으로 서버 측에서 발급하고 저장하며, 클라이언트에 의해 서버에 전달된다

* 서버는 토큰을 검증하고 유효한 사용자 또는 클라이언트를 확인한 후 해당 요청을 처리한다


### JWT(Json Web Token)

* JSON 형식으로 인코딩된 토큰의 한 형태

* 일반 토큰과 달리 사용자 인증에 필요한 정보를 토큰에 담고 있기 때문에 별도의 인증 저장소가 필요없다

* 주로 웹 애플리케이션과 API 인증에 사용된다

* JWT 는 누구나 읽을 수 있기 때문에 민감한 정보는 절대 넣으면 안됨


#### JWT의 형태

<img src="https://raw.githubusercontent.com/pansakr/TIL/refs/heads/main/%EC%9D%B4%EB%AF%B8%EC%A7%80/Spring/Security/jwt.jpg" alt="jwt">

* 헤더, 본문, 서명 의 세 부분으로 구성

* 헤더는 토큰 유형과 사용 중인 서명 알고리즘으로 구성되어 있고 json으로 표기되며 Base64로 인코딩

* 본문은 개인 정보를 포함한 여러 클레임들로 구성되어 있고 json으로 표기되며 Base64로 인코딩

* 서명은 인코딩된 헤더와 본문 + key를 입력으로 헤더에 명시한 암호화 알고리즘으로 생성

* 올바른 키가 있는 사람만 토큰에 서명하거나 서명이 진짜인지 검증할 수 있다

* 만약 해커가 서명된 토큰의 내용을 변경한다면 서명이 무효화되어 리소스 서버가 요청을 거부

```
// 클라이언트가 보낸 jwt토큰이 aaa.bbb.ccc의 형태를 하고 있다면 서버는 해당 jwt토큰을 검증하기 위해 가지고 있는 키를 사용
// aaa.bbb.ccc를 디코딩하고 디코딩한 헤더와 본문 + key를 헤더에 적힌 해시 알고리즘으로 암호화한 결과가 ccc와 같다면 토큰이 변조되지 않았다는것을 확인해 검증을 완료
```

* 서명된 JWT는 JWS(Json Web Token Signed)라고 한다

* 인코딩된 헤더, 본문, 서명의 해시값을 .으로 연결된것이 jwt이다

*클레임 - 정보의 한 조각. name / value 의 한 쌍으로 이루어져 있다


### 세션 인증

* 사용자의 인증 정보가 서버의 세션 저장소에 저장되는 방식

* 사용자가 로그인을 하면 해당 인증 정보를 서버의 세션 저장소에 저장하고, 사용자에게는 저장된 세션 정보의 식별자인 Session ID를 발급

* 발급한 Session ID는 브라우저에 쿠키 형태로 저장되지만, 실제 인증 정보는 서버에 저장되어 있다

* 브라우저는 인증 절차를 마친 이후의 요청마다 HTTP Cookie 헤더에 Session ID를 함께 서버로 전송한다

* 서버는 요청을 전달받고, Session ID에 해당하는 세션 정보가 세션 저장소에 존재한다면 해당 사용자를 인증된 사용자로 판단한다


### JWT 인증

* 인증 정보를 클라이언트가 직접 들고 있는 방식

* 사용자가 인증 성공시 서버가 인증 정보가 담긴 토큰을 생성해 반환

* 이후의 요청마다 사용자가 가지고 있는 토큰을 HTTP의 Authorization 헤더에 실어보낸다

* 이 헤더를 수신한 서버는 토큰이 위변조 되었거나, 만료 시각이 지나지 않은지 확인한 이후 토큰에 담겨있는 사용자 인증 정보를 확인해 사용자를 인가한다

* 대표적인 토큰인 JWT의 경우 디지털 서명이 존재해 토큰의 내용이 위변조 되었는지 서버측에서 확인할 수 있다


### 인증 타입

* Basic - 사용자 아이디와 암호를 Base64로 인코딩한 값을 토큰으로 사용한다 (RFC 7617)

* Bearer - JWT 혹은 OAuth에 대한 토큰을 사용한다 (RFC 6750)

* Digest - 서버에서 난수 데이터 문자열을 클라이언트에 보낸다. 클라이언트는 사용자 정보와 nonce를 포함하는 해시값을 사용하여 응답한다 (RFC 7616)

* HOBA - 전자 서명 기반 인증 (RFC 7486)

* Mutual - 암호를 이용한 클라이언트-서버 상호 인증 (draft-ietf-httpauth-mutual)

* AWS4-HMAC-SHA256 - AWS 전자 서명 기반 인증


### 세션 인증 vs JWT 인증

* 세션
    
  - 서버가 세션 저장소에 사용자 정보를 저장해두고, 브라우저는 세션 ID 만 들고 다님
 
  - 모든 인증 정보를 서버에서 관리하기 때문에 보안 측면에서 조금 더 유리
 
  - 하지만 인증 정보를 서버에 저장하기 때문에 사용자나 데이터의 양이 많아지면 서버의 부담이 증가


* JWT
    
  - 서버가 로그인한 사용자 정보의 일부 + 유효기간을 토큰에 담아서 주고, 클라이언트는 그 토큰을 들고 다님
 
  - 클라이언트가 모든 인증정보를 가지고 있기 때문에 한번 해커에게 탈취당하면 해당 토큰이 만료되기 전까지 피해를 입을 수 밖에 없다

  - 클라이언트가 인증 데이터를 가지고 있기 때문에 유저의 수가 늘어도 부담이 증가하지 않는다


### JWT 위조/변조

* 토큰 내부의 권한 정보를 조작해 일반 사용자가 관리자 권한을 획득 가능

    - 사용자의 고유 ID 를 위조해 다른 사용자인 것처럼 속여 개인정보, 결제 내역 등을 조회하거나 삭제 가능
 
* JWT 위조/변조를 막는 장치

    - 키 : 데이터를 암호화하거나 복호화할 때 사용하는 문자열

    - 서명

        - 해시 함수에 jwt 의 헤더와 페이로드 + 비밀키를 입력값으로 넣고 실행한 결과값

        - 결과물로 ws741g2.. 같은 복잡한 고유 문자열이 나오는데, 이게 서명이다

    - 검증

        - 토큰의 헤더와 페이로드 + 비밀키로 해시함수를 실행해서, 그 값이 서명과 일치하는지 확인하는 것
            
            - 서명 검증 이후 클레임의 만료시간 등도 검증함

        - 페이로드가 바뀌었다면 서명이 깨지기 때문에 서버는 토큰이 변조되었다 판단하고 인증 처리 x
