### 영속성 컨텍스트

* 엔티티를 영구 저장하는 환경

* 엔티티 매니저가 생성될때 하나의 영속성 컨텍스트가 만들어진다.

* 엔티티 매니저의 persist()는 전달받은 엔티티를 영속성 컨텍스트에 저장한다.

* 트랜잭션을 커밋할 때 영속성 컨텍스트에 저장된 엔티티를 db에 반영하고 이것을 flush라 한다.


### 영속성 컨텍스트의 1차 캐시

<img src="https://github.com/pansakr/TIL/assets/118809108/8f1d3b9d-b073-4899-bc82-dc8bd8a20a63">

* 영속성 컨텍스트는 내부에 캐시를 가지고 있고 이 공간을 1차 캐시라 한다. 

* 이곳에 영속 상태의 엔티티를 key(식별자), 값 형태로 저장한다. key는 저장된 엔티티의 @ID, 값은 저장된 엔티티의 인스턴스다. 

```
public <T> T find(Class<T> entityClass, Object primaryKey) // 엔티티 타입과 식별자를 인자로 사용한다.
```

* find()를 호출했을때 1차 캐시에서 식별자(@Id)로 엔티티를 찾아 있다면 가져오고 없다면 db에서 조회한다.

* 만약 없다면 엔티티 매니저는 db 조회 이후 그 값으로 엔티티를 생성하고 1차캐시에 저장해 영속화 한 후 영속 상태의 엔티티를 반환한다.   

```
// 식별자가 같은 엔티티를 조회
Member a = em.find(Member.class, "member1");
Member b = em.find(Member.class, "member1");

// a == b 는 참이다.
// 영속성 컨텍스트는 1차 캐시에 있는 같은 엔티티 인스턴스를 반환한다.
```

*동일성 - 실제 인스턴스가 같다.

*동등성 - 인스턴스는 다를 수 있지만 인스턴스가 가지고 있는 값이 같다.


### 엔티티 생명주기

* 비영속 - 영속성 컨텍스트와 관계가 없는 상태

* 영속 - 영속성 컨텍스트에 저장된 상태. persist()나 조회를 사용하면 영속 상태가 된다.

* 준영속 - 영속성 컨텍스트에 저장되었다가 분리된 상태. detach(), close(), clear()를 사용하면 영속 상태의 엔티티는 준영속 상태가 된다.

* 삭제 - 삭제된 상태. 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다.


### 엔티티 등록, 쓰기 지연 sql 저장소

* 엔티티 매니저로 데이터 변경시 트랜잭션을 시작해야 한다.

* 트랜잭션 시작 후 저장, 수정, 삭제를 하면 변경사항이 영속성 컨텍스트 내부의 1차캐시 영역의 엔티티에 적용된다.

* 그리고 엔티티의 변경사항에 대한 sql을 영속성 컨텍스트 내부의 쓰기 지연 sql 저장소에 모아둔다.

* 트랜잭션 커밋 전까지 변경사항에 대한 작업을 엔티티에 적용하고 해당하는 sql을 모아두었다가 커밋 시 한꺼번에 db에 보낸다.(플러시)


### 플러시(flush)

* 영속성 컨텍스트의 변경 사항을 데이터베이스에 동기화하는 작업(쓰기 지연 sql저장소에 모인 쿼리를 db에 전송)

* 변경 감지가 동작해서 수정 쿼리를 지연 sql 저장소에 등록후 db에 반영한다.

* flush()를 직접 호출하거나 트랜잭션 커밋 시 자동 호출되고 jpql 실행 시 자동 호출된다.


### 엔티티 수정, 변경 감지

* jpa는 엔티티를 영속성 컨텍스트에 보관할 때 최초 상태를 복사해서 저장해두는데 이것을 스냅샷이라 한다.

* 트랜잭션 시작 후 엔티티를 조회해서 영속성 컨텍스트에 영속화 하고, set()으로 엔티티를 수정해 commit()하면 엔티티와 스냅샷을 비교해서 변경된 엔티티를 찾는다.

* 변경된 엔티티가 있으면 수정 sql을 생성해서 쓰기 지연 sql저장소에 보낸다.

* 여기서는 조회 시점의 엔티티 스냅샷과 set()이후 commit()할때의 엔티티가 다르니 해당 변경사항에 대한 sql을 생성해 sql저장소에 보낸다.

* db로 flush 한다.

* 변경 감지는 영속 상태의 엔티티에만 적용된다.

* 비영속, 준영속 상태의 엔티티는 변경해도 db에 반영되지 않는다.


### 엔티티 삭제

* remove()시 영속성 컨텍스트의 엔티티를 삭제하고 해당 sql을 지연 sql저장소에 등록 후 commit()시 db에 반영한다. 
