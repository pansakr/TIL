### VPC

* AWS 같은 클라우드 환경에서 사용할 수 있는 고객 전용 사설 네트워크

    - 사설 네트워크 : 프라이빗(사설) IP 주소 공간을 이용하는 네트워크를 의미함

* AWS 클라우드 내에서 EC2 인스턴스들은 프라이빗 IP를 부여받고, 이를 통해 서로 통신한다

* EC2 생성시 기본 VPC 가 주어지지만, 보안과 구조 최적화를 위해 커스텀 VPC를 설계하는 것이 일반적임

    - DB 서버는 외부 접근이 불필요하므로 퍼블릭 IP를 제거하고 프라이빗 서브넷에 배치

    - 보안 그룹과 포트 설정으로 외부 또는 내부 트래픽을 세밀하게 통제 가능

* 사설 네트워크(VPC) 구성

    - ip 주소 범위 지정

        - 10.0.0.0/16 -> 10.0.0. ~ 10.0.255.254 약 65,000 개의 주소를 사용 가능

    - 서브넷 구성

        - VPC 를 작은 네트워크 단위로 쪼갠 것

        - 사설 네트워크로 사용할 IP 주소 범위가 10개라면 이를 나눠서 5개는 내부망(프라이빗 서브넷), 3개는 외부망(퍼블릭 서브넷), 2개는 관리용 등으로 호스트를 나눠서 구성할 수 있다

        - DB 서버의 경우 외부에서 접근하면 안되니 내부망(프라이빗 서브넷)에 배치

    - 라우팅 및 외부 통신 설정

        - 라우팅 테이블을 통해 서브넷별 통신 경로를 설정
        
        - 퍼블릭 서브넷 : 인터넷 게이트웨이를 통해 외부와 통신

        - 프라이빗 서브넷 : 내부 통신만 허용하거나, NAT 게이트웨이 경유로 제한된 외부 통신

    - 보안 그룹 설정

        - 보안 그룹은 EC2 인스턴스의 방화벽 역할을 하며, 인바운드(들어오는 트래픽)와 아웃바운드(나가는 트래픽)를 규정함

        - DB 서버는 인바운드로 3306 포트만 허용해 오직 웹 서버만 접근 가능하게 설정하거나 외부에서 접근 가능한 서버는 퍼블릭 서브넷에만 배치

    - 퍼블릭 IP 부여 여부

        - 프라이빗 서브넷의 EC2 는 퍼블릭 IP 없이 생성

        - 퍼블릭 IP가 없으면 인터넷에서 직접 접근할 수 없기 때문에, 같은 VPC 내에 있는 퍼블릭 서버를 경유해야 함

### 엘라스틱 빈스톡 배포 v2

* EC2 + RDS 구성

    - RDS : AWS 클라우드에서 관계형 데이터베이스를 쉽게 설치, 운영 및 확장할 수 있도록 하는 웹 서비스

    - 하나의 VPC 에 EC2, RDS를 두고 RDS는 EC2와 로컬 컴퓨터에서만 접근이 가능하고, 외부에서 접근이 불가능도록 설정

        - EC2와 RDS 를 같은 보안 그룹으로 묶으면 같은 보안 그룹끼리만 접근 가능하도록 설정 가능

        - 이 보안 그룹에 3306 포트를 개방해서 EC2에서 RDS로 접근 가능하도록 설정

    - 엘라스틱 빈스톡 생성

        - 단일 인스턴스 선택해 생성

        - 생성 완료 후 왼쪽 탭의 구성 -> 업데이트, 모니터링 및 로깅 -> 편집

        - 맨 아래의 환경 속성 추가 -> 사용할 환경 변수 등록

        - 이 값들은 엘라스틱 빈스톡에서 배포되는 EC2 인스턴스에 환경 변수로 자동 등록됨

        - EC2 인스턴스에서 애플리케이션을 실행하면 해당 애플리케이션에서 환경 변수를 사용할 수 있음

        - db url, username, password 같은 값을 환경 변수로 등록해 두면 애플리케이션에 하드코딩하지 않고 환경 변수만 가져다 쓰면 된다

            ```
            // 엘라스틱 빈스톡 환경 속성
            // EC2 인스턴스에 환경 변수로 등록됨
            RDS_DB_NAME         aaadb

            RDS_HOSTNAME        xxx.com

            RDS_USERNAME        userAAA

            RDS_PASSWORD        user1234
            ```

            ```yml
            # EC2 인스턴스에 등록된 환경 변수를 가져와 사용
            spring:
            datasource:
                url: jdbc:mariadb://${rds.hostname}:${rds.port}/${rds.db.name} 
                driver-class-name: org.mariadb.jdbc.Driver
                username: ${rds.username}
                password: ${rds.password}
            ```

    - RDS 생성

        - AWS에서 RDS 검색 -> Aurora and RDS -> 데이터베이스 생성

        - 데이터베이스 생성 방식 선택 : 표준 생성

        - 엔진 옵션 : 사용할 RDB 선택

        - DB 인스턴스 식별자 : DB 서버 이름

        - 마스터 사용자 이름 : DB 서버의 루트 사용자 ID

        - 마스터 암호 : 루트 사용자 비밀번호

        - VPC : 연결할 EC2 인스턴스와 동일한 VPC

        - 퍼블릭 엑세스 : 예

        - 보안 그룹 : 연결할 EC2 인스턴스와 동일한 보안 그룹

        - 추가 구성 : 데이터베이스 포트 3306

        - RDS 생성 -> 생성 완료 시 엔트포인트를 확인할 수 있고, 이것이 RDS의 주소이다

        - DB 클라이언트 프로그램에 엔드포인트, 사용자 이름, 암호 입력 시 접속됨

    - 보안 그룹 - 인바운드 규칙 편집

        <img src = "https://raw.githubusercontent.com/pansakr/TIL/refs/heads/main/%EC%9D%B4%EB%AF%B8%EC%A7%80/Aws/%EC%9D%B8%EB%B0%94%EC%9A%B4%EB%93%9C%20%EA%B7%9C%EC%B9%99%20%ED%8E%B8%EC%A7%91.JPG" alt="인바운드 규칙 편집">

        - 22, 80 포트는 누구나 접근 가능하고 3306 포트는 내 컴퓨터, 같은 보안 그룹만 접근 가능

        - EC2, RDS 는 같은 보안 그룹을 사용하므로 같은 인바운드 규칙이 적용됨

        - EC2

            - 22, 80 포트 : 전 세계 모든 IP 에서 접근 가능

            - 3306 포트 : 내 컴퓨터 IP, 같은 보안 그룹 접근 가능

        - RDS

            - 22, 80 포트 : 리스닝하지 않음
            
                - 인바운드 규칙에선 허용되었지만 RDS 내부엔 SSH 서버나 웹 서버 프로그램이 존재하지 않고, 실행되지도 않기 때문에 해당 포트로 요청을 받아들이는 일 자체가 없음

                - RDS 는 완전 관리형 서비스이므로 내부 OS에 접근할 수 없고, 사용자 정의 포트 리스닝 설정도 불가능함

                - 처음 설정대로 써야함

            - 3306 포트 : 내 컴퓨터 IP, 같은 보안 그룹 접근 가능 (EC2) 

* 엘라스틱 빈스톡에 jar 배포 후 EC2 IP에 RDS 접근하는 http 요청 시 정상 접근 됨
